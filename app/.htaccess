# BEGIN Custom rules
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Cache busting - removing version from assets file names
    RewriteRule ^(.*?)-packageversion-(\d)+\.(js|css)$ $1.$3

    # 404 for secure files (encrypted one *.secure.*), not meant to be fetched trough browsers by users
    RedirectMatch 404 \.secure\.
    # We do not want to have templates source code leakage [CHUDO-226]
    RedirectMatch 404 \.phtml
    RedirectMatch 404 /xmlrpc\.php
</IfModule>

# Disable runing PHP script inside uploads - it is only directory when WordPress can write
<If "%{REQUEST_URI} =~ m#^\/wp-content\/uploads#">
    php_flag engine off
</If>
# END Custom rules

# Static 404 handling
ErrorDocument 404 /404.php
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
RewriteRule \.(gif|jpe?g|png|bmp|svg) /404.php [NC,L]

<IfModule mod_headers.c>
    # One month for svg and fonts
    <filesMatch ".(woff2|svg|eot|woff|ttf)$">
        Header set Cache-Control "max-age=2628000, public"
    </filesMatch>
</IfModule>

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 300 seconds"
    ExpiresByType application/x-font-woff "access plus 31104000 seconds"
    ExpiresByType application/font-woff2 "access plus 31104000 seconds"
    ExpiresByType application/vnd.ms-fontobject "access plus 31104000 seconds"
    ExpiresByType application/json "access plus 31104000 seconds"
    ExpiresByType application/javascript "access plus 31104000 seconds"
    ExpiresByType application/x-shockwave-flash "access plus 31104000 seconds"
    ExpiresByType application/x-javascript "access plus 31104000 seconds"
    ExpiresByType application/xhtml+xml "access plus 300 seconds"
    ExpiresByType image/svg+xml "access plus 31104000 seconds"
    ExpiresByType image/x-icon "access plus 31104000 seconds"
    ExpiresByType image/vnd.microsoft.icon "access plus 31104000 seconds"
    ExpiresByType image/jpeg "access plus 31104000 seconds"
    ExpiresByType image/png "access plus 31104000 seconds"
    ExpiresByType image/gif "access plus 31104000 seconds"
    ExpiresByType video/mp4 "access plus 31104000 seconds"
    ExpiresByType text/css "access plus 31104000 seconds"
    ExpiresByType text/javascript "access plus 31104000 seconds"
    ExpiresByType text/html "access plus 1800 seconds"
    ExpiresByType text/xml "access plus 300 seconds"
</IfModule>

# BEGIN WordPress
# The directives (lines) between `BEGIN WordPress` and `END WordPress` are
# dynamically generated, and should only be modified via WordPress filters.
# Any changes to the directives between these markers will be overwritten.
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
</IfModule>
# END WordPress
########################## Domain name & protocol ############################

  # Get current protocol
  RewriteRule .* - [E=CURRENT_PROTO:https]
  RewriteCond %{HTTP:X-Forwarded-Proto} !https
  RewriteCond %{HTTPS} off
  RewriteRule .* - [E=CURRENT_PROTO:http]

  # Get current domain name
  RewriteCond %{HTTP_HOST} ^(.*)$
  RewriteRule .* - [E=CURRENT_DOMAIN:%1]

  # Set current root (protocol + domain name)
  # Not really used anywhere
  RewriteRule .* - [E=CURRENT_ROOT:%{ENV:CURRENT_PROTO}://%{ENV:CURRENT_DOMAIN}]

  # Set desired protocol
  RewriteRule .* - [E=DESIRED_PROTO:https]

  # Set desired domain name
  RewriteCond %{HTTP_HOST} ^(.*)$
  RewriteRule .* - [E=DESIRED_DOMAIN:%1]

  # Set desired domain name (from www version)
  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  RewriteRule .* - [E=DESIRED_DOMAIN:%1]

  # Set desired root (protocol + domain name)
  RewriteRule .* - [E=DESIRED_ROOT:%{ENV:DESIRED_PROTO}://%{ENV:DESIRED_DOMAIN}]

  # Default target for blog entires is blog slug,
  # but if we're on the amp version of post we're going properly redirect to amp version of post with new slug
  RewriteRule .* - [E=BLOG_TARGET:blog]

  # Save request uri in environment variable
  # We doing that because when we have redirection
  # request uri change to index.php
  RewriteRule .* - [E=RU:%{REQUEST_URI}]
